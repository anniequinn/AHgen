---
title: "Visualise"
author: 
 - Annie Visser-Quinn & Melissa Bedinger
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: paper
    highlight: haddock
vignette: >
  %\VignetteIndexEntry{Vignette 6 - Visualise}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

rm(list = ls()); cat("\014")

library(knitr)
library(tidyverse)
library(AHgen)
```

<style>
#TOC {
  background: url("images/hex.png");
  background-size: 230px;
  background-position-x: center;
  background-position-y: top;
  padding-top: 280px !important;
  background-repeat: no-repeat;
}
</style>

---

In this vignette, you will find out about pre-set visualisations in `AHgen`:

- Section 1 - Visualising the Abstraction Hierarchy
- Section 2 - Visualising and exploring results

To navigate to other vignettes, go to [Vignette 0 - Welcome to AHgen](Vignette-0---Welcome-to-AHgen.html).


## 1. Visualising the Abstraction Hierarchy

This section will cover pre-set visualisations for the Abstraction Hierarchy itself.
```{r include = FALSE}
dh <- read_adjMat("../inputs/mobilityAH_adjMat_20230629.xlsx") 
dv <- dh %>% select(level, levelName_full, levelName, Node)
de <- dh %>% adjMat_to_edgelist(vInfo = dv)
di <- dh %>% adjMat_to_igraph(vInfo = dv)
di_w <- 
  weight_edges(de, 
               read_xlsx("../inputs/mobilityAH_edges_exampleWeights_20230629.xlsx")) %>%
  edgelist_to_igraph(vInfo = dv)
```
First we need to create a key to specify the positioning of vertices, in `AHgen` called a visKey. This could also be done in a .xlsx file externally and imported into R.
```{r}
visKey =
  tribble(
    ~layer, ~min, ~max, ~addR, ~r,
    1,250,290,0,1,
    2,250,290,0,2,
    3,260,280,0,3,
    4,260,280,0,4,
    5,250,290,0,5)

visKey
```

The `vis_AH_layout()` function generates a layout for visualising an Abstraction Hierarchy i.e. five-level hierarchical network. 

It has five input arguments:

- *edgelist* - the edge list of the network to be visualised
- *vInfo* - the vertex information
- *minSpacing* - the minimum spacing between nodes; by default this is set to `minSpacing = 0`
- *maxSpacing* - the maximum spacing between nodes; by default this is set to `maxSpacing = 100`
- *key* - the key to specify the visualisation layout

```{r}
plot_layout = 
  vis_AH_layout(edgelist = de,
                vInfo = dv,
                minSpacing = 0, 
                maxSpacing = 1000,
                key = visKey)

plot_layout
```

The function `vis_AH_ggplot()` generates a standard ggplot.

It has input arguments:

- *layout* - a layout generated by `vis_AH_layout()`
- *key* - the key to specify the visualisation layout; by default this is set to `key = NULL`
- *vecOpacity* - a vector of four numeric values representing the opacity of edges in each layer; by default this is set to `vecOpacity = c(1, 1, 1, 1)`
- *vecSize* - a vector of five numeric values representing the size of vertices in each level; by default this is set to `vecSize = c(5, 4, 3.5, 3, 2.5)`

```{r}
plot_ggplot = 
  vis_AH_ggplot(layout = plot_layout, 
                key = visKey)

plot_ggplot
```

Lastly is the function `vis_AH_plotly()`. Functions from the package `plotly` are used within `vis_AH_plotly()` to enable the visualisation to be interactive.

It has four input arguments:

- *ggplotPlot* - the plot generated with `vis_AH_ggplot()`
- *layerNames* - a vector of four character strings to be used as identifiers for Abstraction Hierarchy layers; by default this is set to `layerNames = c("Layer 1-2 - Purposes-Outcomes", "Layer 2-3 - Outcomes-Tasks", "Layer 3-4 - Tasks-Processes", "Layer 4-5 - Processes-Resources")`
- *levelNames* - a vector of five character strings to be used as identifiers for Abstraction Hierarchy levels; by default this is set to `levelNames = c("Level 1 - Purposes", "Level 2 - Outcomes", "Level 3 - Tasks", "Level 4 - Processes", "Level 5 - Resources")`
- *circles* - whether the visualisation should be circular; by default this is set to `circles = TRUE`

```{r} 
plot_plotly = 
  vis_AH_plotly(ggplotPlot = plot_ggplot)

plot_plotly
```
Using the building blocks above, it is possible to create an interactive version of an Abstraction Hierarchy. Below you can explore the AHexploreR, an application of this for a generic UK city (the Urban Systems Abstraction Hierarchy, or USAH). 
```{r, echo = FALSE}
knitr::include_app("https://mbedinger.shinyapps.io/AHexploreR/", height = "700px")
```

You can find all underlying code for the AHexploreR, to adapt for your own interactive Abstraction Hierarchy, [on GitHub here](https://github.com/avisserquinn/AHexploreR).


## 2. Visualising the results

This section covers pre-set output styles to visualise and explore the results of network analysis on Abstraction Hierarchies.

### 2.1. Plots

`AHgen` plot styles are bespoke and provided as examples. They have been created thus far during the analysis of Urban Systems Abstraction Hierarchies, and can be adapted for your own purposes.

In the below plots, we use a few custom aesthetics, i.e. specific fonts and colours. *Harding* is a font family which loosely matches Nature journals. You can search online for and download a .ttf file for your chosen font, and load it in R using the [`showtext`](https://cran.rstudio.com/web/packages/showtext/vignettes/introduction.html) package.

```{r}
font_add(family = "Harding", regular = "../inputs/HardingText-Regular-Web.ttf")
showtext_auto()
```

Colours can be loaded directly from `AHgen`, e.g. example data `colsFloodRiver_df` or `colsFloodRiver`. Or you can use your own custom colours!

```{r}
# Cutsom colours for distinguishing between Abstraction Hierarchy levels
colsLevels_df

colsPurposes
colsOutcomes
colsTasks
colsProcesses
colsResources


# Custom colours for comparing 1 in 100-year and 1 in 200-year floods to a baseline Urban Systems Abstraction Hierarchy
colsFloodRiver_df

colsBaseline
colsFloodRiver
colsFloodRiver100
colsFloodRiver200


# Custom colours for distinguishing between different categories of Outcomes and Tasks in the Urban Systems Abstraction Hierarchy
cols100RC_df

colsOutcomes_100RC
colsOutcomes_ES
colsOutcomes_HW
colsOutcomes_IE
colsOutcomes_LS

colsTasks_100RC
colsTasks_ES
colsTasks_HW
colsTasks_IE
colsTasks_LS
```

Plots from these functions may not display accurately in the Plots window of RStudio, but you can export and inspect them with `ggsave()` as below.
```{r, eval = FALSE}
ggsave(
  filenameTimestamp(prefix = "violinHalf_ECvals", 
                    extension = ".png"),
  plot = violinHalf_ECvals, 
  width = 4, height = 3, dpi = 600)
```


#### 2.1.1. Violin plots with `vis_plotViolin()`

The function `vis_plotViolin()` generates violin plots showing the distribution of results values, comparing new scenarios against a benchmark. 

It has five input arguments:

- *results* - the results to be displayed, in standard `AHgen` output format
- *metricName* - the metric for which results will be displayed, e.g. "EC" or "SBC_norm"
- *type* - whether the benchmark results and scenario results are displayed side-by-side (`type = "half"`) or as overlapping wholes (`type = "overlap"`); by default this is set to `type = "half"`)
- *levels* - the levels of the Abstraction Hierarchy for which results will be displayed; by default this is set to `levels = NULL` such that within the function the selection of levels displayed is automated depending on the metric being visualised
- *family* - the font family to visualise; by default this is set to `family = "Harding"`

```{r}
# Read in comparison of scenarios
allScenarios_compared =
  read_rds(
    "../inputs/comparison_USAH_3.0_fiveCities-baseline_fiveCities-floodRiver-100-200_20230720-174337.RDS")

# Reformat scenario column to rename into a more visually friendly format
# assign the new scenario names to ordered levels
# and add the custom colours
results = 
  allScenarios_compared$results %>%
  mutate(scenario = recode(scenario,
                           'floodRiver-100' = '1 in 100-year flood',
                           'floodRiver-200' = '1 in 200-year flood')) %>%
  mutate(scenario = factor(scenario, 
                           levels = c("baseline", 
                                      "1 in 100-year flood", 
                                      "1 in 200-year flood"))) %>%
  full_join(colsFloodRiver_df)

# Half violin plot for Eigenvector Centrality results
violinHalf_ECvals = 
  vis_plotViolin(
    results = results, 
    metricName = "EC", 
    family = "Harding")
violinHalf_ECvals

# Overlap violin plot for Stable Betweenness Centrality results
violinOverlap_SBCvals = 
  vis_plotViolin(
    results = results, 
    metricName = "SBC_norm", 
    type = "overlap", 
    family = "Harding")
violinOverlap_SBCvals
```

To adapt the underlying code for your own purposes, inspect the function with `print()`.
```{r}
print(vis_plotViolin)
```


#### 2.1.2. Scatter plots with `vis_plotScatter()`

The function `vis_plotScatter()` generates scatter plots showing the distribution of either results values, change from benchmark values, or percentage change from benchmark values.

It has nine input arguments:

- *results* - the results to be displayed, in standard `AHgen` output format
- *metricName* - the metric for which results will be displayed, e.g. "EC" or "SBC_norm"
- *AH_benchmark* - the benchmark scenario to compare other scenarios to; by default this is set to `AH_benchmark = "baseline"`
- *type* - the type of results to be displayed; options are `type = "values"`, `type = "valuesChange"`, or `type = "percentChange"`
- *levels* - the levels of the Abstraction Hierarchy for which results will be displayed; by default this is set to `levels = NULL` such that within the function the selection of levels displayed is automated depending on the metric being visualised
- *locations* - ; by default this is set to `locations = NULL`
- *omit.zeros* - ; by default this is set to `omit.zeros = TRUE`
- *omit.inf* - ; by default this is set to `omit.inf = TRUE`
- *family* - the font family to visualise; by default this is set to `family = "Harding"`

```{r}
# Read in comparison of scenarios
allScenarios_compared =
  read_rds(
    "../inputs/comparison_USAH_3.0_fiveCities-baseline_fiveCities-floodRiver-100-200_20230720-174337.RDS")

# Reformat scenario column to rename into a more visually friendly format
# assign the new scenario names to ordered levels
# and add the custom colours
results = 
  allScenarios_compared$results %>%
  mutate(scenario = recode(scenario,
                           'floodRiver-100' = '1 in 100-year flood',
                           'floodRiver-200' = '1 in 200-year flood')) %>%
  mutate(scenario = factor(scenario, 
                           levels = c("baseline", 
                                      "1 in 100-year flood", 
                                      "1 in 200-year flood"))) %>%
  full_join(colsFloodRiver_df)


# Scatter plot of Eigenvector Centrality values
scatter_all_ECvals = 
  vis_plotScatter(
    results = results, 
    metricName = "EC", 
    type = "values")
scatter_all_ECvals

# Scatter plot of Eigenvector Centrality values change for specific levels and locations
scatter_variation_ECvalsChange = 
  vis_plotScatter(
    results = results,
    levels = c("Outcomes", "Tasks"), 
    locations = c("Edinburgh", "Glasgow"),
    metricName = "EC", 
    type = "valuesChange")
scatter_variation_ECvalsChange

# Scatter plot of Stable Betweenness Centrality percent change
scatter_all_SBCpctChange = 
  vis_plotScatter(
    results = results, 
    metricName = "SBC_norm", 
    type = "percentChange")
scatter_all_SBCpctChange
```

#### 2.1.3. Rank change plots with `vis_plotRank()`

The function `vis_plotRank()` generates line charts showing changing rank by level results across scenarios. 

It has seven input arguments:

- *results* - the results to be displayed, in standard `AHgen` output format
- *metricName* - the metric for which results will be displayed, e.g. "EC" or "SBC_norm"
- *AH_benchmark* - the benchmark scenario to compare other scenarios to; by default this is set to `AH_benchmark = "baseline"`
- *levels* - the levels of the Abstraction Hierarchy for which results will be displayed; by default this is set to `levels = NULL` such that within the function the selection of levels displayed is automated depending on the metric being visualised
- *change.only* - a specification to use colours only for vertices with a changed rank; by default this is set to `change.only = FALSE`
- *confidence.lines* - a specification to use line types (e.g. dotted and dashed) to signify confidence ratings of rank changes; by default this is set to `confidence.lines = FALSE`
- *family* - the font family to visualise; by default this is set to `family = "Harding"`

```{r}
# Read in comparison of scenarios
allScenarios_compared =
  read_rds(
    "../inputs/comparison_USAH_3.0_fiveCities-baseline_fiveCities-floodRiver-100-200_20230720-174337.RDS")

# Reformat scenario column to rename into a more visually friendly format
# assign the new scenario names to ordered levels
# and add the custom colours
results = 
  allScenarios_compared$results %>%
  mutate(scenario = recode(scenario,
                           'floodRiver-100' = '1 in 100-year flood',
                           'floodRiver-200' = '1 in 200-year flood')) %>%
  mutate(scenario = factor(scenario, 
                           levels = c("baseline", 
                                      "1 in 100-year flood", 
                                      "1 in 200-year flood"))) %>%
  full_join(cols100RC_df)

# Line rank plot of top Resources and rank changes by Stable Betweenness Centrality
rank_outcomes_ECvals = 
  vis_plotRank(
    results = results, 
    metricName = "EC", 
    levels = "Outcomes", 
    change.only = TRUE)
rank_outcomes_ECvals

# Line rank plot of top Resources and rank changes by Stable Betweenness Centrality
rank_resources_SBCvals = 
  vis_plotRank(
    results = results, 
    metricName = "SBC_norm", 
    levels = "Resources", 
    change.only = TRUE)
rank_resources_SBCvals
```
Note that for Stable Betweenness Centrality ranks - unlike Eigenvector Centrality ranks - multiple vertices can be positioned at the same rank. This is due to having the same number of "shortest paths". For this reason SBC rank is also more prone to low confidence ratings, however these confidence ratings are still displayed for completeness.


#### 2.1.4. Summarising confidence ratings for rank changes with `vis_plotConfidence()`

The function `vis_plotConfidence()` generates bar charts summarising confidence ratings for rank by level results.

It has input arguments:

- *results* - the results to be displayed, in standard `AHgen` output format
- *metricName* - the metric for which results will be displayed, e.g. "EC" or "SBC_norm"
- *type* - the type of results to be displayed; options are `type = "scenarioLevel"`, `type = "scenario"`, `type = "level"`, or `type = "overall"`
- *family* - the font family to visualise; by default this is set to `family = "Harding"`

Note that for Eigenvector Centrality, `type = "scenario"` and `type = "overall"` capture results only for the Purposes, Outcomes, and Tasks levels of the Abstraction Hierarchy. Likewise for Stable Betweenness Centrality, this captures results only for the Tasks, Processes, and Resources levels of the Abstraction Hierarchy.
```{r}
# Confidence ratings for rank by level by Eigenvector Centrality
# broken down by scenario and level
confidence_EC_scenarioLevel = 
  vis_plotConfidence(
    results = allScenarios_compared, 
    metricName = "EC", 
    type = "scenarioLevel")

# Confidence ratings for rank by level by Stable Betweenness Centrality
# broken down by scenario and level
confidence_SBC_scenarioLevel = 
  vis_plotConfidence(
    results = allScenarios_compared, 
    metricName = "SBC_norm", 
    type = "scenarioLevel")

# Confidence ratings for rank by level by Stable Betweenness Centrality
# broken down by scenario
confidence_EC_scenario = 
  vis_plotConfidence(
    results = allScenarios_compared, 
    metricName = "EC", 
    type = "scenario")

# Confidence ratings for rank by level by Stable Betweenness Centrality
# broken down by level
confidence_EC_level = 
  vis_plotConfidence(
    results = allScenarios_compared, 
    metricName = "EC", 
    type = "level")

# Confidence ratings for rank by level by Stable Betweenness Centrality
# overall
confidence_EC_overall = 
  vis_plotConfidence(
    results = allScenarios_compared, 
    metricName = "EC", 
    type = "overall")
```

### 2.2. Tables

It is sometimes useful to summarise results in a table format which can be exported as an Excel sheet, for reports and academic papers. `AHgen` has several preset functions for this.

#### 2.1. Summary tables for number of vertices and edges

The function `table_vertices()` creates a summary table of Abstraction Hierarchy vertices; likewise the function `table_edges()` creates a summary table of Abstraction Hierarchy edges.

They have four input arguments:

- *vSummary* or *eSummary*, respectively - the summary of vertices or edges, in standard `AHgen` output
- *singleScenario* - whether the *vSummary* or *eSummary* include a single scenario or multiple scenarios; by default this is set to `singleScenario = TRUE`
- *compareLocations* - whether the *vSummary* or *eSummary* include multiple locations to be compared; by default this is set to `compareLocations = FALSE`
- *compareScenarios* - whether the *vSummary* or *eSummary* include multiple scenarios to be compared; by default this is set to *compareScenarios = FALSE`

The table provides both the number of vertices (or edges) in each level (or layer), as well as the percentage as compared to the total number of vertices or edges in that Abstraction Hierarchy as a whole.
```{r}
# Read in comparison of scenarios
allScenarios_compared =
  read_rds(
    "../inputs/comparison_USAH_3.0_fiveCities-baseline_fiveCities-floodRiver-100-200_20230720-174337.RDS")

# Create summary table of vertices
# for a single scenario
tbl_vertices_single = 
  table_vertices(
    vSummary = 
      allScenarios_compared$vertices %>% 
      filter(location == "Bristol", scenario == "baseline"))

tbl_vertices_single

# Create summary table of vertices
# comparing location-scenario combinations
tbl_vertices_multi = 
  table_vertices(
    vSummary = allScenarios_compared$vertices, 
    singleScenario = FALSE, 
    compareLocations = TRUE, 
    compareScenarios = TRUE)

tbl_vertices_multi

# Create summary table of edges
# comparing location-scenario combinations
tbl_edges_multi = 
  table_edges(
    eSummary = allScenarios_compared$edges, 
    singleScenario = FALSE, 
    compareLocations = TRUE, 
    compareScenarios = TRUE)

tbl_edges_multi
```

#### 2.2. Summary table for excluded vertices

It has five input arguments:

- *vExcluded_benchmark* - the excluded vertices from the benchmark scenario to be compared against, in standard `AHgen` output format
- *vExcluded_input* - the excluded vertices from the new scenarios to compare, in standard `AHgen` output format
- *singleScenario* - whether the *vExcluded* includes a single scenario or multiple scenarios; by default this is set to `singleScenario = TRUE`
- *compareLocations* - whether the *vExcluded* includes multiple locations to be compared; by default this is set to `compareLocations = FALSE`
- *compareScenarios* - whether the *vExcluded* includes multiple scenarios to be compared; by default this is set to *compareScenarios = FALSE`
```{r}
tbl_vExcluded = 
  table_vExcluded(
    vExcluded_benchmark = "NA", 
    vExcluded_input = allScenarios_compared$vExcluded, 
    singleScenario = FALSE, 
    compareLocations = TRUE, 
    compareScenarios = TRUE)

tbl_vExcluded
```


#### 2.3. Summary table for Degree results

The functions `table_degrees()` generates a table of degree network analysis results for Abstraction Hierarchies.

It has five input arguments:

- *results* - the results to be displayed, in standard `AHgen` output format
- *levels* - the levels of the Abstraction Hierarchy for which results will be displayed; by default this is set to `levels = "all"`
- *singleScenario* - whether the *vExcluded* includes a single scenario or multiple scenarios; by default this is set to `singleScenario = TRUE`
- *compareLocations* - whether the *vExcluded* includes multiple locations to be compared; by default this is set to `compareLocations = FALSE`
- *compareScenarios* - whether the *vExcluded* includes multiple scenarios to be compared; by default this is set to *compareScenarios = FALSE`

```{r}
# Table of degree results for all Abstraction Hierarchy levels
# comparing across multiple locations and scenarios
tbl_degree_all = 
  table_rankDegree(
    results = allScenarios_compared$results, 
    singleScenario = FALSE, 
    compareLocations = TRUE, 
    compareScenarios = TRUE)

tbl_degree_all

# Table of degree results for Resources level
# comparing across multiple locations and scenarios
tbl_degrees_resources = 
  table_rankDegree(
    results = allScenarios_compared$results, 
    levels = "Resources", 
    singleScenario = FALSE, 
    compareLocations = TRUE, 
    compareScenarios = TRUE)

tbl_degrees_resources
```


#### 2.4. Summary table for Eigenvector Centrality results

The functions `table_rankEC()` generates a table of Eigenvector Centrality network analysis results for Abstraction Hierarchies.

It has four input arguments:

- *results* - the results to be displayed, in standard `AHgen` output format
- *singleScenario* - whether the *vExcluded* includes a single scenario or multiple scenarios; by default this is set to `singleScenario = TRUE`
- *compareLocations* - whether the *vExcluded* includes multiple locations to be compared; by default this is set to `compareLocations = FALSE`
- *compareScenarios* - whether the *vExcluded* includes multiple scenarios to be compared; by default this is set to *compareScenarios = FALSE`

```{r}
tbl_EC = 
  table_rankEC(
    results = allScenarios_compared$results,
    singleScenario = FALSE, 
    compareLocations = TRUE, 
    compareScenarios = TRUE)
```

#### 2.5. Summary table for Stable Betweenness Centrality results

The functions `table_rankSBC()` generates a table of Stable Betweenness Centrality network analysis results for Abstraction Hierarchies.

It has four input arguments:

- *results* - the results to be displayed, in standard `AHgen` output format
- *singleScenario* - whether the *vExcluded* includes a single scenario or multiple scenarios; by default this is set to `singleScenario = TRUE`
- *compareLocations* - whether the *vExcluded* includes multiple locations to be compared; by default this is set to `compareLocations = FALSE`
- *compareScenarios* - whether the *vExcluded* includes multiple scenarios to be compared; by default this is set to *compareScenarios = FALSE`

```{r}
tbl_SBC = 
  table_rankSBC(
    results = allScenarios_compared$results,
    singleScenario = FALSE, 
    compareLocations = TRUE, 
    compareScenarios = TRUE)

tbl_SBC
```


#### 2.6. `tables_AHgen()`

For a quick application of `AHgen`'s `table_*()` functions, you can use `tables_AHgen()`.

It has eight input arguments: 

- *vSummary* - the summary of vertices, in standard `AHgen` output
- *eSummary* - the summary of edges, in standard `AHgen` output
- *vExcluded_benchmark* - the excluded vertices from the benchmark scenario to be compared against, in standard `AHgen` output format
- *vExcluded_input* - the excluded vertices from the new scenarios to compare, in standard `AHgen` output format
- *results* - the results to be displayed, in standard `AHgen` output format
- *singleScenario* - whether the *vSummary* or *eSummary* include a single scenario or multiple scenarios; by default this is set to `singleScenario = TRUE`
- *compareLocations* - whether the *vSummary* or *eSummary* include multiple locations to be compared; by default this is set to `compareLocations = FALSE`
- *compareScenarios* - whether the *vSummary* or *eSummary* include multiple scenarios to be compared; by default this is set to *compareScenarios = FALSE`

```{r}
tables_all = 
    tables_AHgen(
      vSummary = allScenarios_compared$vertices,
      eSummary = allScenarios_compared$edges,
      vExcluded_benchmark = "NA", 
      vExcluded_input = allScenarios_compared$vExcluded, 
      results = allScenarios_compared$results,
      singleScenario = FALSE, 
      compareLocations = TRUE, 
      compareScenarios = TRUE)

tables_all
```

Each list element will be treated as an Excel sheet, if you can export it as below using `OSMtidy`'s `exportExcel()` function.

```{r, eval = FALSE}
# Load OSMtidy to use the exportExcel function
p_load(OSMtidy)

# Export
exportExcel(
  inputList = tables_all, 
  filenameTimestamp(
    prefix = "tables_USAH_3.0_fiveCities-baseline_fiveCities-floodRiver-100-200",
    extension = ".xlsx"))
```


## Next
Next in [Vignette 7](Vignette-7), you will find out about... in `AHgen`.

## Last updated
This vignette is associated with `AHgen` v1.0.0, and was last updated by Melissa Bedinger on `r Sys.Date()`.